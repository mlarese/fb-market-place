{
    "name": "Quofind - 4. Cashback Distribution",
    "flow": [
        {
            "id": 1,
            "module": "gateway:CustomWebHook",
            "version": 1,
            "parameters": {"hook": null, "maxResults": 1},
            "mapper": {},
            "metadata": {
                "designer": {
                    "x": 0,
                    "y": 0,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nWEBHOOK: PAYMENT CONFIRMED\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nRiceve notifica quando un pagamento/vendita viene confermato.\n\nğŸ“¥ TRIGGER:\nChiamato dalla Lambda Payments quando:\nâ€¢ Venditore conferma vendita via Messenger\nâ€¢ Pagamento esterno confermato\nâ€¢ Admin conferma manualmente\n\nğŸ“¦ PAYLOAD:\n{\n  \"event\": \"payment.confirmed\",\n  \"paymentId\": \"pay_abc123\",\n  \"listingId\": \"lst_xyz\",\n  \"sellerId\": \"fb_seller_id\",\n  \"buyerId\": \"fb_buyer_id\",\n  \"amount\": 350.00,\n  \"currency\": \"EUR\",\n  \"timestamp\": \"2024-01-15T...\"\n}\n\nğŸ”— VARIABILI:\nâ€¢ {{1.paymentId}} â†’ ID pagamento\nâ€¢ {{1.sellerId}} â†’ Venditore\nâ€¢ {{1.buyerId}} â†’ Compratore\nâ€¢ {{1.amount}} â†’ Importo vendita\n\nğŸ’¡ CONFIGURAZIONE:\nL'URL di questo webhook va inserito nella Lambda Payments come MAKE_CASHBACK_WEBHOOK_URL.",
                        "position": "bottom"
                    }
                },
                "expect": [
                    {"name": "event", "type": "text"},
                    {"name": "paymentId", "type": "text"},
                    {"name": "listingId", "type": "text"},
                    {"name": "sellerId", "type": "text"},
                    {"name": "buyerId", "type": "text"},
                    {"name": "amount", "type": "number"},
                    {"name": "currency", "type": "text"},
                    {"name": "timestamp", "type": "text"}
                ]
            }
        },
        {
            "id": 2,
            "module": "http:ActionSendData",
            "version": 3,
            "parameters": {},
            "mapper": {
                "url": "https://3nw6p7c866.execute-api.eu-west-1.amazonaws.com/dev/payments/{{1.paymentId}}",
                "method": "GET",
                "headers": [],
                "parseResponse": true
            },
            "metadata": {
                "designer": {
                    "x": 300,
                    "y": 0,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nRECUPERA DETTAGLI PAGAMENTO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ”— ENDPOINT: GET /payments/{id}\n\nğŸ“¥ RISPOSTA:\n{\n  \"id\": \"pay_abc123\",\n  \"listingId\": \"lst_xyz\",\n  \"sellerId\": \"fb_seller\",\n  \"buyerId\": \"fb_buyer\",\n  \"amount\": 350.00,\n  \"sellerGroupId\": \"grp_123\" | null,\n  \"buyerGroupId\": \"grp_456\" | null,\n  \"sellerReferrerId\": \"fb_referrer\" | null,\n  \"buyerReferrerId\": \"fb_referrer2\" | null,\n  \"listing\": {...},\n  \"seller\": {...},\n  \"buyer\": {...}\n}\n\nğŸ’¡ Include info su gruppi e referrer per calcolare distribuzione cashback.",
                        "position": "bottom"
                    }
                }
            }
        },
        {
            "id": 3,
            "module": "http:ActionSendData",
            "version": 3,
            "parameters": {},
            "mapper": {
                "url": "https://3nw6p7c866.execute-api.eu-west-1.amazonaws.com/dev/cashback/config",
                "method": "GET",
                "headers": [],
                "parseResponse": true
            },
            "metadata": {
                "designer": {
                    "x": 600,
                    "y": 0,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nRECUPERA CONFIG CASHBACK\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ”— ENDPOINT: GET /cashback/config\n\nğŸ“¥ RISPOSTA:\n{\n  \"commissionRate\": 0.05,      // 5% commissione piattaforma\n  \"sellerCashbackRate\": 0.02,  // 2% al venditore\n  \"buyerCashbackRate\": 0.01,   // 1% al compratore\n  \"leaderCashbackRate\": 0.005, // 0.5% al group leader\n  \"referrerCashbackRate\": 0.005, // 0.5% al referrer\n  \"pendingDays\": 30,           // Giorni prima del rilascio\n  \"minWithdrawal\": 10.00       // Minimo prelievo\n}\n\nğŸ’¡ DISTRIBUZIONE ESEMPIO (vendita 100â‚¬):\nâ€¢ Commissione: 5â‚¬\nâ€¢ Venditore: 2â‚¬\nâ€¢ Compratore: 1â‚¬\nâ€¢ Group leader: 0.50â‚¬\nâ€¢ Referrer: 0.50â‚¬\nâ€¢ Piattaforma: 1â‚¬",
                        "position": "bottom"
                    }
                }
            }
        },
        {
            "id": 4,
            "module": "util:SetVariables",
            "version": 1,
            "parameters": {},
            "mapper": {
                "variables": [
                    {"name": "commission", "value": "{{1.amount * 3.data.commissionRate}}"},
                    {"name": "sellerCashback", "value": "{{1.amount * 3.data.sellerCashbackRate}}"},
                    {"name": "buyerCashback", "value": "{{1.amount * 3.data.buyerCashbackRate}}"},
                    {"name": "leaderCashback", "value": "{{1.amount * 3.data.leaderCashbackRate}}"},
                    {"name": "referrerCashback", "value": "{{1.amount * 3.data.referrerCashbackRate}}"},
                    {"name": "releaseDate", "value": "{{addDays(now; 3.data.pendingDays)}}"}
                ]
            },
            "metadata": {
                "designer": {
                    "x": 900,
                    "y": 0,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCALCOLA IMPORTI CASHBACK\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ“Š CALCOLI:\nâ€¢ commission = amount Ã— commissionRate\nâ€¢ sellerCashback = amount Ã— sellerCashbackRate\nâ€¢ buyerCashback = amount Ã— buyerCashbackRate\nâ€¢ leaderCashback = amount Ã— leaderCashbackRate\nâ€¢ referrerCashback = amount Ã— referrerCashbackRate\nâ€¢ releaseDate = now + pendingDays\n\nğŸ“¤ VARIABILI OUTPUT:\nâ€¢ {{4.commission}} â†’ Es: 17.50â‚¬\nâ€¢ {{4.sellerCashback}} â†’ Es: 7.00â‚¬\nâ€¢ {{4.buyerCashback}} â†’ Es: 3.50â‚¬\nâ€¢ {{4.leaderCashback}} â†’ Es: 1.75â‚¬\nâ€¢ {{4.referrerCashback}} â†’ Es: 1.75â‚¬\nâ€¢ {{4.releaseDate}} â†’ Data rilascio",
                        "position": "bottom"
                    }
                }
            }
        },
        {
            "id": 5,
            "module": "http:ActionSendData",
            "version": 3,
            "parameters": {},
            "mapper": {
                "url": "https://3nw6p7c866.execute-api.eu-west-1.amazonaws.com/dev/cashback/credit",
                "method": "POST",
                "headers": [{"name": "Content-Type", "value": "application/json"}],
                "bodyType": "raw",
                "contentType": "application/json",
                "body": "{\"userId\": \"{{1.sellerId}}\", \"amount\": {{4.sellerCashback}}, \"type\": \"sale_cashback\", \"status\": \"pending\", \"referenceId\": \"{{1.paymentId}}\", \"releaseDate\": \"{{4.releaseDate}}\", \"description\": \"Cashback vendita {{2.data.listing.title}}\"}",
                "parseResponse": true
            },
            "metadata": {
                "designer": {
                    "x": 1200,
                    "y": -200,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nACCREDITA CASHBACK VENDITORE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ”— ENDPOINT: POST /cashback/credit\n\nğŸ“¤ BODY:\nâ€¢ userId: ID venditore\nâ€¢ amount: importo cashback\nâ€¢ type: 'sale_cashback'\nâ€¢ status: 'pending' (diventa 'available' dopo 30gg)\nâ€¢ referenceId: ID pagamento\nâ€¢ releaseDate: quando diventa prelevabile\n\nğŸ’¡ STATUS PENDING:\nIl cashback Ã¨ visibile ma non prelevabile.\nDopo 30 giorni, lo Scenario 5 lo rilascia.",
                        "position": "bottom"
                    }
                }
            }
        },
        {
            "id": 6,
            "module": "http:ActionSendData",
            "version": 3,
            "parameters": {},
            "mapper": {
                "url": "https://graph.facebook.com/v18.0/me/messages?access_token=YOUR_PAGE_ACCESS_TOKEN",
                "method": "POST",
                "headers": [{"name": "Content-Type", "value": "application/json"}],
                "bodyType": "raw",
                "contentType": "application/json",
                "body": "{\"recipient\":{\"id\":\"{{1.sellerId}}\"},\"messaging_type\":\"MESSAGE_TAG\",\"tag\":\"CONFIRMED_EVENT_UPDATE\",\"message\":{\"text\":\"ğŸ’° Cashback accreditato!\\n\\nHai guadagnato {{4.sellerCashback}}â‚¬ dalla vendita di:\\nğŸ“¦ {{2.data.listing.title}}\\nğŸ’µ Venduto a: {{1.amount}}â‚¬\\n\\nâ³ Disponibile dal: {{formatDate(4.releaseDate; \\\"DD/MM/YYYY\\\")}}\\n\\nGrazie per aver usato Quofind! ğŸ‰\",\"quick_replies\":[{\"content_type\":\"text\",\"title\":\"ğŸ’° Vedi saldo\",\"payload\":\"BALANCE\"},{\"content_type\":\"text\",\"title\":\"ğŸ“œ Storico\",\"payload\":\"TRANSACTIONS\"}]}}",
                "parseResponse": true
            },
            "metadata": {
                "designer": {
                    "x": 1500,
                    "y": -200,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nNOTIFICA VENDITORE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ“¤ MESSAGGIO:\n\"ğŸ’° Cashback accreditato!\n\nHai guadagnato Xâ‚¬ dalla vendita di:\n[Titolo]\nVenduto a: Yâ‚¬\n\nDisponibile dal: DD/MM/YYYY\"",
                        "position": "bottom"
                    }
                }
            }
        },
        {
            "id": 7,
            "module": "builtin:BasicRouter",
            "version": 1,
            "parameters": {"else": 0},
            "mapper": null,
            "metadata": {
                "designer": {
                    "x": 1200,
                    "y": 0,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nROUTER: HA COMPRATORE?\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâ†’ ROUTE 1: SÃ¬, accredita buyer cashback\n   Filtro: buyerId != null\n\nâ†’ ROUTE 2: No (vendita esterna)\n   Skip",
                        "position": "bottom"
                    }
                }
            },
            "routes": [
                {
                    "flow": [
                        {
                            "id": 8,
                            "module": "http:ActionSendData",
                            "version": 3,
                            "parameters": {},
                            "mapper": {
                                "url": "https://3nw6p7c866.execute-api.eu-west-1.amazonaws.com/dev/cashback/credit",
                                "method": "POST",
                                "headers": [{"name": "Content-Type", "value": "application/json"}],
                                "bodyType": "raw",
                                "contentType": "application/json",
                                "body": "{\"userId\": \"{{1.buyerId}}\", \"amount\": {{4.buyerCashback}}, \"type\": \"purchase_cashback\", \"status\": \"pending\", \"referenceId\": \"{{1.paymentId}}\", \"releaseDate\": \"{{4.releaseDate}}\", \"description\": \"Cashback acquisto {{2.data.listing.title}}\"}",
                                "parseResponse": true
                            },
                            "metadata": {
                                "designer": {
                                    "x": 1500,
                                    "y": 0,
                                    "notes": {
                                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nACCREDITA CASHBACK COMPRATORE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nAnche il compratore riceve cashback per incentivare l'uso della piattaforma.",
                                        "position": "bottom"
                                    }
                                }
                            },
                            "filter": {
                                "name": "Has Buyer",
                                "conditions": [[{"a": "{{1.buyerId}}", "b": "", "o": "text:notequal"}]]
                            }
                        },
                        {
                            "id": 9,
                            "module": "http:ActionSendData",
                            "version": 3,
                            "parameters": {},
                            "mapper": {
                                "url": "https://graph.facebook.com/v18.0/me/messages?access_token=YOUR_PAGE_ACCESS_TOKEN",
                                "method": "POST",
                                "headers": [{"name": "Content-Type", "value": "application/json"}],
                                "bodyType": "raw",
                                "contentType": "application/json",
                                "body": "{\"recipient\":{\"id\":\"{{1.buyerId}}\"},\"messaging_type\":\"MESSAGE_TAG\",\"tag\":\"CONFIRMED_EVENT_UPDATE\",\"message\":{\"text\":\"ğŸ Cashback per te!\\n\\nHai guadagnato {{4.buyerCashback}}â‚¬ per l'acquisto di:\\nğŸ“¦ {{2.data.listing.title}}\\n\\nâ³ Disponibile dal: {{formatDate(4.releaseDate; \\\"DD/MM/YYYY\\\")}}\"}}",
                                "parseResponse": true
                            },
                            "metadata": {"designer": {"x": 1800, "y": 0, "notes": {"text": "Notifica compratore", "position": "bottom"}}}
                        }
                    ]
                }
            ]
        },
        {
            "id": 10,
            "module": "builtin:BasicRouter",
            "version": 1,
            "parameters": {"else": 0},
            "mapper": null,
            "metadata": {
                "designer": {
                    "x": 1200,
                    "y": 200,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nROUTER: SELLER HA GROUP LEADER?\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSe il venditore fa parte di un gruppo, il leader riceve cashback.\n\nâ†’ ROUTE 1: SÃ¬, accredita leader\n   Filtro: sellerGroupId != null",
                        "position": "bottom"
                    }
                }
            },
            "routes": [
                {
                    "flow": [
                        {
                            "id": 11,
                            "module": "http:ActionSendData",
                            "version": 3,
                            "parameters": {},
                            "mapper": {
                                "url": "https://3nw6p7c866.execute-api.eu-west-1.amazonaws.com/dev/groups/{{2.data.sellerGroupId}}",
                                "method": "GET",
                                "headers": [],
                                "parseResponse": true
                            },
                            "metadata": {
                                "designer": {
                                    "x": 1500,
                                    "y": 200,
                                    "notes": {
                                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nRECUPERA DATI GRUPPO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nOttiene l'ID del group leader.",
                                        "position": "bottom"
                                    }
                                }
                            },
                            "filter": {
                                "name": "Seller Has Group",
                                "conditions": [[{"a": "{{2.data.sellerGroupId}}", "b": "", "o": "text:notequal"}]]
                            }
                        },
                        {
                            "id": 12,
                            "module": "http:ActionSendData",
                            "version": 3,
                            "parameters": {},
                            "mapper": {
                                "url": "https://3nw6p7c866.execute-api.eu-west-1.amazonaws.com/dev/cashback/credit",
                                "method": "POST",
                                "headers": [{"name": "Content-Type", "value": "application/json"}],
                                "bodyType": "raw",
                                "contentType": "application/json",
                                "body": "{\"userId\": \"{{11.data.leaderId}}\", \"amount\": {{4.leaderCashback}}, \"type\": \"leader_commission\", \"status\": \"pending\", \"referenceId\": \"{{1.paymentId}}\", \"releaseDate\": \"{{4.releaseDate}}\", \"description\": \"Commissione leader - Vendita membro {{2.data.seller.name}}\"}",
                                "parseResponse": true
                            },
                            "metadata": {
                                "designer": {
                                    "x": 1800,
                                    "y": 200,
                                    "notes": {
                                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nACCREDITA GROUP LEADER\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nIl leader riceve una commissione sulle vendite dei membri del suo gruppo.\n\nğŸ’¡ INCENTIVO GRUPPI:\nMotiva i leader a reclutare e supportare venditori attivi.",
                                        "position": "bottom"
                                    }
                                }
                            }
                        },
                        {
                            "id": 13,
                            "module": "http:ActionSendData",
                            "version": 3,
                            "parameters": {},
                            "mapper": {
                                "url": "https://graph.facebook.com/v18.0/me/messages?access_token=YOUR_PAGE_ACCESS_TOKEN",
                                "method": "POST",
                                "headers": [{"name": "Content-Type", "value": "application/json"}],
                                "bodyType": "raw",
                                "contentType": "application/json",
                                "body": "{\"recipient\":{\"id\":\"{{11.data.leaderId}}\"},\"messaging_type\":\"MESSAGE_TAG\",\"tag\":\"CONFIRMED_EVENT_UPDATE\",\"message\":{\"text\":\"ğŸ‘‘ Commissione Leader!\\n\\nHai guadagnato {{4.leaderCashback}}â‚¬ dalla vendita di un membro del tuo gruppo.\\n\\nğŸ‘¤ Membro: {{2.data.seller.name}}\\nğŸ“¦ Articolo: {{2.data.listing.title}}\\nğŸ’µ Vendita: {{1.amount}}â‚¬\"}}",
                                "parseResponse": true
                            },
                            "metadata": {"designer": {"x": 2100, "y": 200, "notes": {"text": "Notifica leader", "position": "bottom"}}}
                        }
                    ]
                }
            ]
        },
        {
            "id": 14,
            "module": "builtin:BasicRouter",
            "version": 1,
            "parameters": {"else": 0},
            "mapper": null,
            "metadata": {
                "designer": {
                    "x": 1200,
                    "y": 400,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nROUTER: SELLER HA REFERRER?\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSe il venditore Ã¨ stato invitato da qualcuno, il referrer riceve commissione.\n\nğŸ’¡ PROGRAMMA REFERRAL:\nChi invita nuovi utenti guadagna sulle loro vendite.",
                        "position": "bottom"
                    }
                }
            },
            "routes": [
                {
                    "flow": [
                        {
                            "id": 15,
                            "module": "http:ActionSendData",
                            "version": 3,
                            "parameters": {},
                            "mapper": {
                                "url": "https://3nw6p7c866.execute-api.eu-west-1.amazonaws.com/dev/cashback/credit",
                                "method": "POST",
                                "headers": [{"name": "Content-Type", "value": "application/json"}],
                                "bodyType": "raw",
                                "contentType": "application/json",
                                "body": "{\"userId\": \"{{2.data.sellerReferrerId}}\", \"amount\": {{4.referrerCashback}}, \"type\": \"referral_commission\", \"status\": \"pending\", \"referenceId\": \"{{1.paymentId}}\", \"releaseDate\": \"{{4.releaseDate}}\", \"description\": \"Commissione referral - Vendita {{2.data.seller.name}}\"}",
                                "parseResponse": true
                            },
                            "metadata": {
                                "designer": {
                                    "x": 1500,
                                    "y": 400,
                                    "notes": {
                                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nACCREDITA REFERRER\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nChi ha invitato il venditore guadagna una commissione.",
                                        "position": "bottom"
                                    }
                                }
                            },
                            "filter": {
                                "name": "Seller Has Referrer",
                                "conditions": [[{"a": "{{2.data.sellerReferrerId}}", "b": "", "o": "text:notequal"}]]
                            }
                        },
                        {
                            "id": 16,
                            "module": "http:ActionSendData",
                            "version": 3,
                            "parameters": {},
                            "mapper": {
                                "url": "https://graph.facebook.com/v18.0/me/messages?access_token=YOUR_PAGE_ACCESS_TOKEN",
                                "method": "POST",
                                "headers": [{"name": "Content-Type", "value": "application/json"}],
                                "bodyType": "raw",
                                "contentType": "application/json",
                                "body": "{\"recipient\":{\"id\":\"{{2.data.sellerReferrerId}}\"},\"messaging_type\":\"MESSAGE_TAG\",\"tag\":\"CONFIRMED_EVENT_UPDATE\",\"message\":{\"text\":\"ğŸ¯ Commissione Referral!\\n\\nHai guadagnato {{4.referrerCashback}}â‚¬ perchÃ© un utente che hai invitato ha venduto qualcosa!\\n\\nğŸ‘¤ Utente: {{2.data.seller.name}}\\nğŸ“¦ Articolo: {{2.data.listing.title}}\"}}",
                                "parseResponse": true
                            },
                            "metadata": {"designer": {"x": 1800, "y": 400, "notes": {"text": "Notifica referrer", "position": "bottom"}}}
                        }
                    ]
                }
            ]
        },
        {
            "id": 17,
            "module": "http:ActionSendData",
            "version": 3,
            "parameters": {},
            "mapper": {
                "url": "https://3nw6p7c866.execute-api.eu-west-1.amazonaws.com/dev/payments/{{1.paymentId}}/complete",
                "method": "POST",
                "headers": [{"name": "Content-Type", "value": "application/json"}],
                "bodyType": "raw",
                "contentType": "application/json",
                "body": "{\"cashbackDistributed\": true, \"distributedAt\": \"{{now}}\", \"totalDistributed\": {{4.sellerCashback + 4.buyerCashback + 4.leaderCashback + 4.referrerCashback}}}",
                "parseResponse": true
            },
            "metadata": {
                "designer": {
                    "x": 1800,
                    "y": -200,
                    "notes": {
                        "text": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nMARCA PAGAMENTO COMPLETATO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nAggiorna il record pagamento con info distribuzione.\n\nğŸ”— ENDPOINT: POST /payments/{id}/complete\n\nğŸ“¤ BODY:\nâ€¢ cashbackDistributed: true\nâ€¢ distributedAt: timestamp\nâ€¢ totalDistributed: somma tutti i cashback\n\nğŸ’¡ Questo previene distribuzioni duplicate se il webhook viene chiamato piÃ¹ volte.",
                        "position": "bottom"
                    }
                }
            }
        }
    ],
    "metadata": {
        "version": 1,
        "scenario": {
            "roundtrips": 1,
            "maxErrors": 3,
            "autoCommit": true,
            "autoCommitTriggerLast": true,
            "sequential": false
        },
        "designer": {"orphans": []},
        "notes": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSCENARIO 4: CASHBACK DISTRIBUTION\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nğŸ“‹ DESCRIZIONE:\nDistribuisce il cashback a tutti i beneficiari quando una vendita viene confermata.\n\nğŸ’° BENEFICIARI:\n1. VENDITORE â†’ 2% (incentivo a vendere)\n2. COMPRATORE â†’ 1% (incentivo a comprare)\n3. GROUP LEADER â†’ 0.5% (se venditore in gruppo)\n4. REFERRER â†’ 0.5% (se venditore invitato)\n\nğŸ”„ FLUSSO:\n\n1. WEBHOOK riceve payment.confirmed\n   â†“\n2. GET payment details (include gruppi, referrer)\n   â†“\n3. GET cashback config (percentuali)\n   â†“\n4. Calcola importi per ogni beneficiario\n   â†“\n5. POST /cashback/credit per SELLER â†’ Notifica\n   â†“\n6. Se BUYER: POST /cashback/credit â†’ Notifica\n   â†“\n7. Se LEADER: GET gruppo â†’ POST /cashback/credit â†’ Notifica\n   â†“\n8. Se REFERRER: POST /cashback/credit â†’ Notifica\n   â†“\n9. POST /payments/{id}/complete\n\nâš™ï¸ CONFIGURAZIONI:\nâ€¢ YOUR_PAGE_ACCESS_TOKEN\nâ€¢ Webhook URL in Lambda Payments\n\nğŸ“Š ESEMPIO (vendita 350â‚¬):\nâ€¢ Commissione piattaforma: 17.50â‚¬\nâ€¢ Venditore: 7.00â‚¬\nâ€¢ Compratore: 3.50â‚¬\nâ€¢ Leader: 1.75â‚¬\nâ€¢ Referrer: 1.75â‚¬\nâ€¢ Piattaforma netto: 3.50â‚¬\n\nâ³ STATO PENDING:\nTutti i cashback sono 'pending' per 30 giorni.\nLo Scenario 5 li rilascia automaticamente.\n\nğŸ“Š OPERAZIONI: ~6-12 per vendita"
    }
}
